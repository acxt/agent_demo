# 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户界面层                          │
│         FastHTML + DaisyUI + HTMX                       │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────────────┐
│                   Flask API层                            │
│              RESTful API + 路由管理                      │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────────────┐
│                  Agent核心层                             │
│          LangGraph工作流 + 状态管理                      │
│                                                          │
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │热点发现 │→ │视频分析  │→ │提示词生成│→ │视频生成 │ │
│  └─────────┘  └──────────┘  └──────────┘  └─────────┘ │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────────────┐
│                   工具层                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌─────────────────┐ │
│  │ HotspotFinder│ │VideoAnalyzer │ │PromptGenerator  │ │
│  │  (B站爬虫)   │ │  (内容分析)  │ │  (LLM生成)      │ │
│  └──────────────┘ └──────────────┘ └─────────────────┘ │
└──────────────────┬──────────────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────────────┐
│                 外部服务层                               │
│    Bilibili API | Gemini API | VEO API                  │
└─────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. Agent核心 (`src/agent/`)

#### 状态管理 (`state.py`)
- 定义Agent执行状态
- 管理任务生命周期
- 存储中间结果

#### 工作流图 (`graph.py`)
- LangGraph状态机定义
- 节点和边的配置
- 条件路由逻辑

#### 节点实现 (`nodes.py`)
- `route_task`: 任务路由
- `find_hotspots`: 热点发现
- `analyze_video`: 视频分析
- `generate_prompt`: 提示词生成
- `create_video`: 视频生成
- `format_output`: 结果格式化

### 2. 工具层 (`src/tools/`)

#### HotspotFinder
- B站视频搜索
- 热度评分算法
- 时间衰减计算

#### VideoAnalyzer
- 视频详情获取
- 评论区分析
- 关键词提取

#### PromptGenerator
- LLM提示词生成
- 上下文构建
- JSON格式化

#### VideoGenerator
- VEO API集成
- 视频生成管理
- 状态追踪

### 3. UI层 (`src/ui/`)

#### FastHTML组件 (`components.py`)
- 页面布局
- DaisyUI组件封装
- HTMX集成

#### Flask应用 (`app.py`)
- 路由定义
- API处理
- 任务管理

## 数据流

1. **用户输入** → 前端表单
2. **创建任务** → Flask API接收
3. **初始化状态** → Agent State
4. **执行工作流** → LangGraph处理
5. **节点调用** → 工具层执行
6. **外部API** → 第三方服务
7. **结果返回** → 状态更新
8. **UI刷新** → HTMX自动更新

## 技术选型

### 前端
- **FastHTML**: Python原生HTML生成
- **DaisyUI**: Tailwind CSS组件库
- **HTMX**: 无JS前端交互

### 后端
- **Flask**: 轻量级Web框架
- **LangChain**: LLM框架
- **LangGraph**: 工作流状态机

### AI服务
- **Gemini**: 提示词生成
- **VEO**: 视频生成

## 扩展点

1. **添加新工具**: 在`tools/`目录创建
2. **自定义节点**: 修改`agent/nodes.py`
3. **扩展UI**: 在`ui/components.py`添加组件
4. **数据持久化**: 集成数据库（SQLite/PostgreSQL）
5. **异步任务**: 集成Celery/RQ

